{{- $architecture := or .architecture "arm64" -}}
{{- $username := or .username "mobian" -}}
{{- $password := or .password "1234" -}}
{{- $hostname := or .hostname "mobian" -}}

architecture: {{ $architecture }}

actions:
  - action: debootstrap
    suite: bullseye
    components:
      - main
      - contrib
      - non-free
    mirror: http://deb.debian.org/debian
    variant: minbase

  - action: apt
    recommends: false
    description: Install security packages
    packages:
      - ca-certificates
      - gnupg
      - wget

  - action: overlay
    source: overlays/rootfs

  - action: run
    description: Setup Mobian repository
    chroot: true
    command: wget -O - https://repo.mobian-project.org/mobian.gpg.key | apt-key add -

  - action: apt
    recommends: false
    description: Install mobian-specific packages
    packages:
      - mobian-phosh
      - mobian-phosh-games
      - eog
      - epiphany-browser
      - firefox-esr
      - fractal
      - gnome-authenticator
      - gnome-sound-recorder
      - gnome-todo
      - powersupply
      - telegram-desktop

  - action: run
    description: Set up default user
    chroot: true
    script: scripts/setup-user.sh {{ $username }} {{ $password }}

  - action: run
    description: Set up system
    chroot: true
    script: scripts/setup-system.sh {{ $hostname }}

  - action: pack
    file: rootfs-{{ $architecture }}.tar.gz
